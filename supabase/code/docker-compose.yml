version: "3.9"

services:
  # -----------------------------
  # POSTGRES + PGVECTOR
  # -----------------------------
  db:
    image: supabase/postgres:15.1.1.0
    container_name: supabase-db
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
      PGDATA: /var/lib/postgresql/data
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # -----------------------------
  # SUPAVISOR (connection pooling)
  # NECESARIO para IA, n8n, LangChain
  # -----------------------------
  supavisor:
    image: supabase/supavisor:latest
    container_name: supabase-supavisor
    restart: unless-stopped
    environment:
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - db
    ports:
      - "6543:6543"

  # -----------------------------
  # REST API
  # -----------------------------
  rest:
    image: supabase/postgrest:v12.0.2
    container_name: supabase-rest
    restart: unless-stopped
    depends_on:
      - db
    environment:
      PGRST_DB_URI: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/postgres
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
    ports:
      - "3000:3000"

  # -----------------------------
  # KONG (API Gateway)
  # -----------------------------
  kong:
    image: supabase/kong:latest
    container_name: supabase-kong
    restart: unless-stopped
    depends_on:
      - rest
    environment:
      KONG_DATABASE: off
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
    volumes:
      - ./kong.yml:/var/lib/kong/kong.yml
    ports:
      - "8000:8000"
      - "8443:8443"

  # -----------------------------
  # EDGE FUNCTIONS (opcional, pero Ãºtil)
  # -----------------------------
  functions:
    image: supabase/edge-runtime:latest
    container_name: supabase-functions
    restart: unless-stopped
    environment:
      SUPABASE_URL: http://kong:8000
      SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SERVICE_ROLE_KEY}
    depends_on:
      - kong
    ports:
      - "9000:9000"

# -----------------------------
# VOLUMES
# -----------------------------
volumes:
  db_data:
